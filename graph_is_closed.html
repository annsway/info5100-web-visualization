<html>
    <style></style>

    <body>

        <head>
            <script src="https://d3js.org/d3.v7.min.js"></script>
        </head>
        <div>
            <svg id="barchart" height="400" width="400" style="background: #F5F5F5; margin-bottom: 30px;"></svg>
        </div>
        <script>
            let svg = d3.select("svg#barchart");
            const width = svg.attr("width");
            const height = svg.attr("height");
            const margin = { top: 10, right: 10, bottom: 30, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            d3.json("yelp_business.json")
                .then((data) => {
                    console.log(data);
                    // count is_open by state
                    operations = {}
                    // {state: {is_open: xx, is_closed: xxx}}
                    for (let i = 0; i < data.length; i++) {
                        let state = data[i].state;
                        if (!(state in operations)) {
                            operations[state] = { 'is_open': 0, 'is_closed': 0 };
                        }
                        if (data[i].is_open == 1) {
                            operations[state].is_open += 1;
                        }
                        if (data[i].is_open == 0) {
                            operations[state].is_closed += 1;
                        }
                    }
                    let json = []
                    for (const [key, value] of Object.entries(operations)) {
                        let dict = { "state": key, "is_open": value.is_open, "is_closed": value.is_closed }
                        json.push(dict);
                    }

                    console.log(json);

                    let maxValue = d3.max(json, d => Math.max(d.is_open, d.is_closed));
                    console.log(maxValue);

                    // scaleBand() is used for categorical x 
                    let xScale = d3.scaleBand()
                        .domain(d3.range(json.length))
                        .rangeRound([0, width])
                        .paddingInner(0.05);

                    let openScale = d3.scaleLinear()
                        .domain([0, maxValue])
                        .range([0, height / 2.0]);

                    let closedScale = d3.scaleLinear()
                        .domain([0, maxValue])
                        .range([0, height / 2.0]);

                    // append is_open
                    svg.selectAll("line")
                        .data(json)
                        .enter()
                        .append("line")
                        .attr("x1", function (d, i) {
                            return xScale(i);
                        })
                        .attr("x2", function (d, i) {
                            return xScale(i);
                        })
                        .attr("y1", function (d) {
                            return height / 2;
                        })
                        .attr("y2", function (d) {
                            return height / 2 - openScale(d.is_open);
                        })
                        .style("stroke", "#5555F0")
                        .style("stroke-width", 10);

                    // append is_closed
                    svg.selectAll("line")
                        .data(json)
                        .enter()
                        .append("line")
                        .attr("x1", function (d, i) {
                            return xScale(i);
                        })
                        .attr("x2", function (d, i) {
                            return xScale(i);
                        })
                        .attr("y1", function (d) {
                            return height / 2;
                        })
                        .attr("y2", function (d) {
                            return height / 2 + closedScale(d.is_closed);
                        })
                        .style("stroke", "#F05555")
                        .style("stroke-width", 10);
                });

        </script>
    </body>

</html>
